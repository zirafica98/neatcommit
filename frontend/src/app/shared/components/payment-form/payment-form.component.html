<div class="payment-form">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>lock</mat-icon>
        Secure Payment
      </mat-card-title>
      <mat-card-subtitle *ngIf="isDemo">
        <mat-icon>verified</mat-icon>
        Demo Mode - No real payment required
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="plan-summary">
        <h3>{{ plan.name }} Plan</h3>
        <p class="price" *ngIf="finalPrice === plan.price">
          ${{ plan.price }}<span class="interval">/{{ plan.interval }}</span>
        </p>
        <p class="price" *ngIf="finalPrice !== plan.price">
          <span class="original-price">${{ plan.price }}</span>
          <span class="discounted-price">${{ finalPrice.toFixed(2) }}</span>
          <span class="interval">/{{ plan.interval }}</span>
          <span class="discount-badge" *ngIf="promoCodeDiscount > 0">
            -{{ promoCodeDiscount }}% OFF
          </span>
        </p>
      </div>

      <!-- Promo Code Section -->
      <div class="promo-code-section">
        <mat-form-field appearance="outline" class="promo-code-field">
          <mat-label>Promo Code</mat-label>
          <input
            matInput
            [(ngModel)]="promoCode"
            (blur)="validatePromoCode()"
            (keyup.enter)="validatePromoCode()"
            placeholder="Enter promo code"
            [disabled]="promoCodeValidating"
          />
          <mat-icon matPrefix>local_offer</mat-icon>
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="validatePromoCode()"
            [disabled]="promoCodeValidating || !promoCode"
            *ngIf="!promoCodeValid"
          >
            <mat-icon>check_circle</mat-icon>
          </button>
          <mat-icon matSuffix *ngIf="promoCodeValid && !promoCodeValidating">check_circle</mat-icon>
          <mat-spinner *ngIf="promoCodeValidating" matSuffix diameter="20"></mat-spinner>
        </mat-form-field>
        <div class="promo-code-message" *ngIf="promoCodeError">
          <mat-icon>error</mat-icon>
          <span>{{ promoCodeError }}</span>
        </div>
        <div class="promo-code-message success" *ngIf="promoCodeValid && !promoCodeError">
          <mat-icon>check_circle</mat-icon>
          <span>Promo code applied! {{ promoCodeDiscount }}% discount</span>
        </div>
      </div>

      <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Card Number</mat-label>
            <input
              matInput
              formControlName="cardNumber"
              placeholder="1234 5678 9012 3456"
              (input)="formatCardNumber($event)"
              maxlength="19"
            />
            <mat-icon matPrefix>credit_card</mat-icon>
            <mat-error *ngIf="paymentForm.get('cardNumber')?.hasError('required')">
              Card number is required
            </mat-error>
            <mat-error *ngIf="paymentForm.get('cardNumber')?.hasError('pattern')">
              Invalid card number
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Expiry Date</mat-label>
            <input
              matInput
              formControlName="expiryDate"
              placeholder="MM/YY"
              (input)="formatExpiryDate($event)"
              maxlength="5"
            />
            <mat-error *ngIf="paymentForm.get('expiryDate')?.hasError('required')">
              Expiry date is required
            </mat-error>
            <mat-error *ngIf="paymentForm.get('expiryDate')?.hasError('pattern')">
              Invalid format (MM/YY)
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>CVV</mat-label>
            <input
              matInput
              formControlName="cvv"
              placeholder="123"
              type="password"
              maxlength="3"
            />
            <mat-error *ngIf="paymentForm.get('cvv')?.hasError('required')">
              CVV is required
            </mat-error>
            <mat-error *ngIf="paymentForm.get('cvv')?.hasError('pattern')">
              Invalid CVV
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Cardholder Name</mat-label>
            <input matInput formControlName="cardholderName" placeholder="John Doe" />
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="paymentForm.get('cardholderName')?.hasError('required')">
              Cardholder name is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Billing Address</mat-label>
            <input matInput formControlName="billingAddress" placeholder="123 Main St" />
            <mat-icon matPrefix>home</mat-icon>
            <mat-error *ngIf="paymentForm.get('billingAddress')?.hasError('required')">
              Billing address is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>City</mat-label>
            <input matInput formControlName="city" placeholder="New York" />
            <mat-error *ngIf="paymentForm.get('city')?.hasError('required')">
              City is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>ZIP Code</mat-label>
            <input matInput formControlName="zipCode" placeholder="10001" />
            <mat-error *ngIf="paymentForm.get('zipCode')?.hasError('required')">
              ZIP code is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Country</mat-label>
            <input matInput formControlName="country" placeholder="United States" />
            <mat-icon matPrefix>public</mat-icon>
            <mat-error *ngIf="paymentForm.get('country')?.hasError('required')">
              Country is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="onCancel()">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="!isDemo && !paymentForm.valid">
            <mat-icon>check</mat-icon>
            {{ isDemo ? 'Complete (Demo)' : 'Pay Now' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
