<div class="repositories-container">
  <div class="repositories-header fade-in">
    <div>
      <h1>Repositories</h1>
      <p class="subtitle">
        <span *ngIf="currentProvider === 'github'">{{ showAllRepos ? 'All repositories from GitHub (where App is installed)' : 'Repositories in database' }}</span>
        <span *ngIf="currentProvider === 'gitlab'">GitLab projekti</span>
        <span *ngIf="currentProvider === 'bitbucket'">Bitbucket repozitorijumi</span>
      </p>
    </div>
    <div class="header-actions">
      <!-- GitHub: toggle sve / samo u bazi + Add nije potreban (dodaje se preko "Show All" i Add to Database) -->
      <button *ngIf="currentProvider === 'github'" mat-raised-button color="primary" (click)="toggleView()">
        <mat-icon>{{ showAllRepos ? 'list' : 'cloud_download' }}</mat-icon>
        {{ showAllRepos ? 'Show Database Repos' : 'Show All GitHub Repos' }}
      </button>
      <!-- GitLab: samo forma za dodavanje projekta -->
      <button *ngIf="currentProvider === 'gitlab'" mat-stroked-button (click)="showGitLabForm = !showGitLabForm">
        <mat-icon>add</mat-icon>
        {{ showGitLabForm ? 'Sakrij formu' : 'Dodaj GitLab projekat' }}
      </button>
      <!-- Bitbucket: samo forma za dodavanje repozitorijuma -->
      <button *ngIf="currentProvider === 'bitbucket'" mat-stroked-button (click)="showBitbucketForm = !showBitbucketForm">
        <mat-icon>add</mat-icon>
        {{ showBitbucketForm ? 'Sakrij formu' : 'Dodaj Bitbucket repozitorijum' }}
      </button>
    </div>
  </div>

  <div *ngIf="currentProvider === 'gitlab' && showGitLabForm" class="gitlab-section">
    <h3>GitLab</h3>
    <p class="gitlab-hint">Connect with a Personal or Project Access Token, then add projects. Configure the Merge Request webhook in GitLab to point to your NeatCommit <code>POST /webhook/gitlab</code> URL.</p>
    <div class="gitlab-connect">
      <input type="password" [(ngModel)]="gitlabToken" placeholder="GitLab access token" class="gitlab-input" />
      <button mat-raised-button color="primary" (click)="connectGitLab()" [disabled]="gitlabConnecting">
        {{ gitlabConnecting ? 'Connecting...' : 'Connect GitLab' }}
      </button>
    </div>
    <div class="gitlab-add">
      <input [(ngModel)]="gitlabProjectId" placeholder="Project ID (number or path)" class="gitlab-input" />
      <input [(ngModel)]="gitlabFullName" placeholder="Full path (e.g. group/project)" class="gitlab-input" />
      <input [(ngModel)]="gitlabName" placeholder="Project name" class="gitlab-input" />
      <input [(ngModel)]="gitlabDefaultBranch" placeholder="Default branch" class="gitlab-input" />
      <button mat-raised-button (click)="addGitLabProject()" [disabled]="gitlabAdding">
        {{ gitlabAdding ? 'Adding...' : 'Add GitLab project' }}
      </button>
    </div>
  </div>

  <div *ngIf="currentProvider === 'bitbucket' && showBitbucketForm" class="gitlab-section">
    <h3>Bitbucket</h3>
    <p class="gitlab-hint">Connect with your Bitbucket username and App Password, then add repositories. Configure the Pull Request webhook to your NeatCommit <code>POST /webhook/bitbucket</code> URL.</p>
    <div class="gitlab-connect">
      <input [(ngModel)]="bitbucketUsername" placeholder="Bitbucket username or email" class="gitlab-input" />
      <input type="password" [(ngModel)]="bitbucketToken" placeholder="App password" class="gitlab-input" />
      <button mat-raised-button color="primary" (click)="connectBitbucket()" [disabled]="bitbucketConnecting">
        {{ bitbucketConnecting ? 'Connecting...' : 'Connect Bitbucket' }}
      </button>
    </div>
    <div class="gitlab-add">
      <input [(ngModel)]="bitbucketWorkspace" placeholder="Workspace" class="gitlab-input" />
      <input [(ngModel)]="bitbucketRepoSlug" placeholder="Repo slug" class="gitlab-input" />
      <input [(ngModel)]="bitbucketFullName" placeholder="Full path (workspace/repo)" class="gitlab-input" />
      <input [(ngModel)]="bitbucketName" placeholder="Repository name" class="gitlab-input" />
      <input [(ngModel)]="bitbucketDefaultBranch" placeholder="Default branch" class="gitlab-input" />
      <button mat-raised-button (click)="addBitbucketProject()" [disabled]="bitbucketAdding">
        {{ bitbucketAdding ? 'Adding...' : 'Add Bitbucket repo' }}
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading repositories...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadRepositories()">
      Retry
    </button>
  </div>

  <div *ngIf="!loading && !error" class="repositories-content">
    <div *ngIf="repositories.length === 0" class="empty-state">
      <mat-icon>folder</mat-icon>
      <h3>No repositories found</h3>
      <ng-container *ngIf="currentProvider === 'github'">
        <p *ngIf="error && error.includes('GitHub account')" class="error-message">{{ error }}</p>
        <p *ngIf="!error || !error.includes('GitHub account')">
          Repositories will be automatically added when you open a Pull Request in a repository where the GitHub App is installed.
        </p>
        <p *ngIf="!error || !error.includes('GitHub account')" class="help-text">
          If you've already installed the GitHub App, make sure you're logged in with the same GitHub account.
        </p>
        <a mat-raised-button color="primary" href="https://github.com/apps/neatcommit" target="_blank">
          <mat-icon>add</mat-icon>
          Install GitHub App
        </a>
      </ng-container>
      <ng-container *ngIf="currentProvider === 'gitlab'">
        <p>Dodajte GitLab projekat pomoću forme iznad (Dodaj GitLab projekat).</p>
      </ng-container>
      <ng-container *ngIf="currentProvider === 'bitbucket'">
        <p>Dodajte Bitbucket repozitorijum pomoću forme iznad (Dodaj Bitbucket repozitorijum).</p>
      </ng-container>
    </div>

    <div *ngIf="repositories.length > 0" class="repositories-grid">
      <mat-card *ngFor="let repo of repositories" class="repo-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>folder</mat-icon>
            {{ repo.fullName }}
            <span *ngIf="repo.provider === 'gitlab'" class="provider-chip gitlab">GitLab</span>
            <span *ngIf="repo.provider === 'bitbucket'" class="provider-chip bitbucket">Bitbucket</span>
            <span *ngIf="repo.provider === 'github' || !repo.provider" class="provider-chip github">GitHub</span>
          </mat-card-title>
          <mat-card-subtitle>
            <span *ngIf="repo.private" class="private-badge">
              <mat-icon>lock</mat-icon>
              Private
            </span>
            <span *ngIf="!repo.private" class="public-badge">
              <mat-icon>public</mat-icon>
              Public
            </span>
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="repo-info">
            <div class="repo-meta">
              <span *ngIf="repo.language" class="language-chip" [style.background-color]="getLanguageColor(repo.language) + '20'">
                <span class="language-dot" [style.background-color]="getLanguageColor(repo.language)"></span>
                {{ repo.language }}
              </span>
              <span class="branch-info">
                <mat-icon>code_branch</mat-icon>
                {{ repo.defaultBranch }}
              </span>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <div class="toggle-container">
            <span class="toggle-label">Analysis</span>
            <mat-slide-toggle
              *ngIf="repo.provider === 'gitlab' || repo.provider === 'bitbucket' || (repo.id && repo.id !== repo.githubRepoId?.toString())"
              [checked]="repo.enabled"
              (change)="toggleRepository(repo)"
              color="primary">
            </mat-slide-toggle>
            <button
              *ngIf="repo.provider !== 'gitlab' && repo.provider !== 'bitbucket' && (!repo.id || repo.id === repo.githubRepoId?.toString())"
              mat-raised-button
              color="primary"
              (click)="addRepositoryToDatabase(repo)"
              class="add-repo-button">
              <mat-icon>add</mat-icon>
              Add to Database
            </button>
          </div>
          <a mat-button color="primary" [attr.href]="repoExternalUrl(repo)" target="_blank">
            <mat-icon>open_in_new</mat-icon>
            {{ repoExternalLabel(repo) }}
          </a>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>
