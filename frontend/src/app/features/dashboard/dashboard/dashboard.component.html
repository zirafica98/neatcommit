<div class="dashboard-container">
  <div class="dashboard-header fade-in">
    <div>
      <h1>Dashboard</h1>
      <p class="subtitle">Overview of your code reviews and security analysis</p>
    </div>
    <div class="header-actions">
      <div *ngIf="hasActivelyAnalyzing" class="pending-indicator">
        <mat-icon>sync</mat-icon>
        <span>Analyzing reviews...</span>
      </div>
      <button mat-raised-button color="primary" (click)="exportStatsToExcel()">
        <mat-icon>file_download</mat-icon>
        Export Statistics
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading dashboard...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadDashboardStats()">
      Retry
    </button>
  </div>

  <div *ngIf="analyticsLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading analytics...</p>
  </div>

  <!-- Subscription Warning -->
  <div *ngIf="subscription && subscription.warnings && subscription.subscription" class="subscription-warning fade-in">
    <mat-card [class.warning-expired]="subscription.warnings.isExpired" [class.warning-expiring]="subscription.warnings.isExpiringSoon">
      <mat-card-content>
        <div class="warning-content">
          <mat-icon [color]="subscription.warnings.isExpired ? 'warn' : 'accent'">
            {{ subscription.warnings.isExpired ? 'error' : 'warning' }}
          </mat-icon>
          <div class="warning-text">
            <h3 *ngIf="subscription.warnings.isExpired">Your subscription has expired</h3>
            <h3 *ngIf="!subscription.warnings.isExpired && subscription.warnings.isExpiringSoon">
              Your subscription expires in {{ subscription.warnings.daysUntilExpiry }} day(s)
            </h3>
            <p *ngIf="subscription.warnings.isExpired">
              Please select a new plan to continue using NeatCommit.
            </p>
            <p *ngIf="!subscription.warnings.isExpired && subscription.warnings.isExpiringSoon">
              Renew your subscription to avoid service interruption.
            </p>
          </div>
          <button mat-raised-button color="primary" routerLink="/app/pricing">
            <mat-icon>workspace_premium</mat-icon>
            Select Plan
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Subscription Usage Card -->
  <div *ngIf="subscription && subscription.subscription && subscription.limits && !subscriptionLoading" class="subscription-usage-card fade-in">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>workspace_premium</mat-icon>
          <span>Current Plan: {{ subscription.subscription.planType }}</span>
        </mat-card-title>
        <mat-card-subtitle>
          <a routerLink="/app/pricing" class="upgrade-link">Upgrade Plan</a>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="usage-item">
          <div class="usage-header">
            <span class="usage-label">Reviews This Month</span>
            <span class="usage-text">
              {{ subscription.limits.usage.reviewsUsed }} /
              {{ subscription.limits.reviewsPerMonth === null ? '∞' : subscription.limits.reviewsPerMonth }}
            </span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getUsagePercentage(subscription.limits.usage.reviewsUsed, subscription.limits.reviewsPerMonth)"
            [color]="getUsagePercentage(subscription.limits.usage.reviewsUsed, subscription.limits.reviewsPerMonth) > 80 ? 'warn' : 'primary'"
          ></mat-progress-bar>
        </div>
        <div class="usage-item">
          <div class="usage-header">
            <span class="usage-label">Repositories</span>
            <span class="usage-text">
              {{ subscription.limits.usage.repositoriesUsed }} /
              {{ subscription.limits.repositories === null ? '∞' : subscription.limits.repositories }}
            </span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getUsagePercentage(subscription.limits.usage.repositoriesUsed, subscription.limits.repositories)"
            [color]="getUsagePercentage(subscription.limits.usage.repositoriesUsed, subscription.limits.repositories) > 80 ? 'warn' : 'primary'"
          ></mat-progress-bar>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading && !error && stats" class="dashboard-content">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card" 
                matTooltip="Overall security score based on all completed reviews (0-100 scale)" 
                matTooltipPosition="above">
        <mat-card-content>
          <div class="stat-icon" [style.background]="getScoreGradient(stats.averageScore)">
            <mat-icon>security</mat-icon>
          </div>
          <div class="stat-info">
            <h3>Security Score</h3>
            <p class="stat-value" [style.color]="getScoreColor(stats.averageScore)">
              {{ stats.averageScore }}/100
            </p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon stat-icon-blue">
            <mat-icon>rate_review</mat-icon>
          </div>
          <div class="stat-info">
            <h3>Total Reviews</h3>
            <p class="stat-value">{{ stats.totalReviews }}</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon stat-icon-red">
            <mat-icon>bug_report</mat-icon>
          </div>
          <div class="stat-info">
            <h3>Total Issues</h3>
            <p class="stat-value">{{ stats.totalIssues }}</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon stat-icon-orange">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-info">
            <h3>Critical Issues</h3>
            <p class="stat-value">{{ stats.criticalIssues }}</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Analytics Charts -->
    <div *ngIf="analyticsLoading" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading analytics...</p>
    </div>
    
    <div *ngIf="!analyticsLoading && !analytics" class="empty-state">
      <mat-icon>bar_chart</mat-icon>
      <p>No analytics data available yet</p>
    </div>
    
    <div class="charts-grid" *ngIf="analytics && !analyticsLoading">
      <!-- Security Score Trend -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Security Score Trend (30 days)
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <canvas #scoreTrendChart></canvas>
        </mat-card-content>
      </mat-card>

      <!-- Issues by Category -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>pie_chart</mat-icon>
            Issues by Category
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <canvas #issuesCategoryChart></canvas>
        </mat-card-content>
      </mat-card>

      <!-- Review Activity -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Review Activity (30 days)
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <canvas #activityChart></canvas>
        </mat-card-content>
      </mat-card>

      <!-- Repositories by Status -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>donut_large</mat-icon>
            Repositories by Status
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <canvas #reposStatusChart></canvas>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Issue Breakdown -->
    <mat-card class="issues-card">
      <mat-card-header>
        <mat-card-title>Issue Breakdown</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="issues-grid">
          <div class="issue-item">
            <div class="issue-badge issue-badge-critical">
              <mat-icon>error</mat-icon>
            </div>
            <div class="issue-info">
              <p class="issue-label">Critical</p>
              <p class="issue-count">{{ stats.criticalIssues }}</p>
            </div>
          </div>
          <div class="issue-item">
            <div class="issue-badge issue-badge-high">
              <mat-icon>warning</mat-icon>
            </div>
            <div class="issue-info">
              <p class="issue-label">High</p>
              <p class="issue-count">{{ stats.highIssues }}</p>
            </div>
          </div>
          <div class="issue-item">
            <div class="issue-badge issue-badge-medium">
              <mat-icon>info</mat-icon>
            </div>
            <div class="issue-info">
              <p class="issue-label">Medium</p>
              <p class="issue-count">{{ stats.mediumIssues }}</p>
            </div>
          </div>
          <div class="issue-item">
            <div class="issue-badge issue-badge-low">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="issue-info">
              <p class="issue-label">Low</p>
              <p class="issue-count">{{ stats.lowIssues }}</p>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recent Reviews -->
    <mat-card class="reviews-card">
      <mat-card-header>
        <mat-card-title>Recent Reviews</mat-card-title>
        <button mat-button routerLink="/app/reviews">View All</button>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="stats.recentReviews.length === 0" class="empty-state">
          <mat-icon>rate_review</mat-icon>
          <p>No reviews yet</p>
        </div>
        <div *ngFor="let review of stats.recentReviews" 
             class="review-item" 
             [class.analyzing]="isAnalyzing(review.id)"
             [routerLink]="['/app/reviews', review.id]">
          <div class="review-header">
            <div class="review-title-section">
              <h4>{{ review.githubPrTitle }}</h4>
              <div *ngIf="isAnalyzing(review.id)" class="analyzing-badge">
                <mat-spinner diameter="16"></mat-spinner>
                <span>Analyzing...</span>
              </div>
            </div>
            <span *ngIf="!isAnalyzing(review.id)" class="review-score" [style.color]="getScoreColor(review.securityScore)">
              {{ review.securityScore }}/100
            </span>
            <span *ngIf="isAnalyzing(review.id)" class="review-score analyzing-score">
              <mat-spinner diameter="20"></mat-spinner>
            </span>
          </div>
          <div class="review-meta">
            <span class="review-repo">{{ review.repository?.fullName || 'Unknown' }}</span>
            <span class="review-date">{{ review.createdAt | date: 'short' }}</span>
          </div>
          <div class="review-issues">
            <span *ngIf="review.criticalIssues > 0" class="issue-tag critical">
              {{ review.criticalIssues }} Critical
            </span>
            <span *ngIf="review.highIssues > 0" class="issue-tag high">
              {{ review.highIssues }} High
            </span>
            <span *ngIf="review.totalIssues === 0" class="issue-tag success">
              No Issues
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
